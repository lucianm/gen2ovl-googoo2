--- xbmc-9999.ebuild	2013-10-14 00:06:20.878641000 +0200
+++ xbmc-9998.ebuild	2013-09-05 07:31:23.000000000 +0200
@@ -1,6 +1,6 @@
 # Copyright 1999-2013 Gentoo Foundation
 # Distributed under the terms of the GNU General Public License v2
-# Exp $
+# $Header: /var/cvsroot/gentoo-x86/media-tv/xbmc/xbmc-9999.ebuild,v 1.151 2013/09/05 05:06:56 vapier Exp $
 
 EAPI="5"
 
@@ -13,9 +13,7 @@
 
 case ${PV} in
 9999)
-	EGIT_REPO_URI="${XBMC_EGIT_REPO_URI:-git://github.com/xbmc/xbmc.git}"
-	EGIT_PROJECT="${PN}${XBMC_EGIT_PROJECT:-}.git"
-	EGIT_BRANCH="${XBMC_EGIT_BRANCH:-master}"
+	EGIT_REPO_URI="git://github.com/xbmc/xbmc.git"
 	inherit git-2
 	SRC_URI="!java? ( mirror://gentoo/${P}-20130413-generated-addons.tar.xz )"
 	;;
@@ -38,7 +36,7 @@
 
 LICENSE="GPL-2"
 SLOT="0"
-IUSE="airplay alsa altivec avahi bluetooth bluray caps cec css debug +fishbmc gles goom java joystick midi mysql neon nfs +opengl profile +projectm pulseaudio pvr +rsxs rtmp +samba +sdl sse sse2 sftp udev upnp +usb vaapi vdpau webserver +X +xrandr ffmpeg"
+IUSE="airplay alsa altivec avahi bluetooth bluray caps cec css debug +fishbmc gles goom java joystick midi mysql neon nfs +opengl profile +projectm pulseaudio pvr +rsxs rtmp +samba +sdl sse sse2 sftp udev upnp +usb vaapi vdpau webserver +X +xrandr"
 REQUIRED_USE="
 	pvr? ( mysql )
 	rsxs? ( X )
@@ -93,10 +91,7 @@
 	media-libs/tiff
 	pulseaudio? ( media-sound/pulseaudio )
 	media-sound/wavpack
-	ffmpeg? (
-		|| ( media-libs/libpostproc media-video/ffmpeg )
-		>=virtual/ffmpeg-9[encode]
-	)
+	|| ( >=media-video/ffmpeg-1.2.1:0=[encode] ( media-libs/libpostproc >=media-video/libav-10_alpha:=[encode] ) )
 	rtmp? ( media-video/rtmpdump )
 	avahi? ( net-dns/avahi )
 	nfs? ( net-fs/libnfs )
@@ -119,7 +114,7 @@
 	vaapi? ( x11-libs/libva[opengl] )
 	vdpau? (
 		|| ( x11-libs/libvdpau >=x11-drivers/nvidia-drivers-180.51 )
-		ffmpeg? ( virtual/ffmpeg[vdpau] )
+		|| ( >=media-video/ffmpeg-1.2.1:0=[vdpau] >=media-video/libav-10_alpha:=[vdpau] )
 	)
 	X? (
 		x11-apps/xdpyinfo
@@ -143,6 +138,13 @@
 
 pkg_setup() {
 	python-single-r1_pkg_setup
+
+	if has_version 'media-video/libav' ; then
+		ewarn "Building ${PN} against media-video/libav is not supported upstream."
+		ewarn "It requires building a (small) wrapper library with some code"
+		ewarn "from media-video/ffmpeg."
+		ewarn "If you experience issues, please try with media-video/ffmpeg."
+	fi
 }
 
 src_unpack() {
@@ -211,8 +213,8 @@
 		--disable-ccache \
 		--disable-optimizations \
 		--enable-external-libraries \
+		$(has_version 'media-video/libav' && echo "--enable-libav-compat") \
 		--enable-gl \
-		$(use_enable ffmpeg external-ffmpeg) \
 		$(use_enable airplay) \
 		$(use_enable avahi) \
 		$(use_enable bluray libbluray) \
